# 📊 资源规划数据导入模块 - 用户指南

## 🎉 模块概述

**状态**：✅ 100%完成  
**交付日期**：2025-11-24  
**功能**：从Excel导入BPS工程师资源规划数据，支持追加模式和版本追踪

---

## 🚀 快速开始（3步）

### 第1步：创建数据库表（2分钟）

```bash
1. 打开 Supabase Dashboard
2. 进入 SQL Editor
3. 复制粘贴 RESOURCE_PLANNING_DATABASE_SCHEMA.sql 全部内容
4. 点击 RUN
5. 等待 "Setup Complete!" 提示
```

### 第2步：启动应用（1分钟）

```bash
npm run dev
```

### 第3步：开始导入（30秒）

```bash
1. 访问 http://localhost:5173
2. 点击左侧"资源规划导入"
3. 选择年份
4. 上传Excel文件
5. 查看导入结果
```

---

## 📋 Excel格式要求

### 标准格式（示例1）

```
┌──────────┬──────┬──────┬──────┬──────┬──────┐
│ 姓名     │ CW1  │ CW2  │ CW3  │ CW4  │ CW5  │
├──────────┼──────┼──────┼──────┼──────┼──────┤
│ 王宁     │ WS   │      │ P    │ P    │      │
│ 李华     │      │ T    │ T    │      │ M    │
│ 张三     │ C    │ C    │ C    │      │      │
└──────────┴──────┴──────┴──────┴──────┴──────┘
```

**关键要点**：
- 第1行：周数表头（CW1, CW2, CW3...）
- 第2行起：员工姓名 + 每周任务
- 任务代码：WS, P, T, C, M等（见下方图例）
- 空单元格：表示该周无任务

---

### 合并单元格格式（自动识别）

```
┌──────────┬──────────────────────┬──────┐
│ 姓名     │ CW1-CW3              │ CW4  │
├──────────┼──────────────────────┼──────┤
│ 王宁     │ WS - BPS Workshop    │ P    │
│ 李华     │ P - FCGNa Project    │ M    │
└──────────┴──────────────────────┴──────┘
```

**自动识别逻辑**：
- 连续相同任务代码 → 自动合并为跨周任务
- 例如：CW1=WS, CW2=WS, CW3=WS → 自动识别为 CW1-CW3 Workshop

---

## 🎨 任务类型图例

| 代码 | 名称 | 颜色 | 说明 |
|------|------|------|------|
| WS | Workshop | 蓝色 #3B82F6 | 研讨会/工作坊 |
| SW | Speed Week | 紫色 #8B5CF6 | 快速周改善活动 |
| P | Project | 绿色 #10B981 | 项目实施 |
| T | Training | 橙色 #F59E0B | 培训课程 |
| C | Coaching | 红色 #EF4444 | 辅导指导 |
| M | Meeting | 靛蓝 #6366F1 | 会议 |
| L | Leave | 灰色 #64748B | 休假 |
| SD | Self-Develop | 青色 #14B8A6 | 自我发展 |
| A | Assessment | 粉色 #EC4899 | 评估审核 |
| S | Support | 天蓝 #06B6D4 | 现场支持 |
| O | Others | 浅灰 #9CA3AF | 其他 |

---

## 📝 使用流程

### 场景1：首次导入

**步骤**：
1. 准备Excel文件（按照上述格式）
2. 打开"资源规划导入"页面
3. 选择年份（如2025）
4. 点击"选择文件并导入"
5. 选择Excel文件
6. 等待解析和导入
7. 查看导入结果

**预期结果**：
- ✅ 显示成功导入的任务数
- ✅ 列出任何错误或警告
- ✅ 在导入历史中显示新批次

---

### 场景2：追加导入（更新数据）

**步骤**：
1. 修改Excel文件（如添加新任务）
2. 再次导入（选择相同年份）
3. 系统自动追加新记录
4. 自动标记为最新版本

**关键特性**：
- **追加模式**：不删除旧数据，追加新记录
- **版本追踪**：通过 `imported_at` 时间戳区分版本
- **最新显示**：自动显示每个员工+时间段的最新任务

**示例**：
```
第1次导入（2025-01-10）：
  王宁 | CW1 | Workshop

第2次导入（2025-01-15）：
  王宁 | CW1 | Project   ← 更新

数据库中保留2条记录，但显示时只显示最新的"Project"
```

---

### 场景3：删除批次

**步骤**：
1. 在导入历史列表中找到要删除的批次
2. 点击"垃圾桶"图标
3. 确认删除
4. 该批次的所有任务被删除

**⚠️ 警告**：
- 删除操作不可撤销
- 删除批次会删除该批次的所有任务记录
- 如果该批次是最新版本，会显示上一个批次的数据

---

## 🔍 常见问题排查

### Q1：导入失败 - "未找到员工"

**原因**：Excel中的员工姓名与数据库不匹配

**解决方案**：
1. 检查Excel中的员工姓名拼写
2. 确保员工已在"能力评估"模块中导入
3. 员工名称必须完全一致（区分大小写）

**验证**：
```sql
-- 在Supabase SQL Editor中查询员工列表
SELECT id, name, employee_id FROM employees;
```

---

### Q2：导入失败 - "未找到有效的周数列"

**原因**：表头格式不正确

**解决方案**：
- 确保第1行包含周数（格式：CW1, CW2, CW3...）
- 不要使用其他格式（如"Week 1", "第1周"）
- 周数列必须从第2列开始（第1列为员工姓名）

**正确格式**：
```
| 姓名   | CW1 | CW2 | CW3 | ← 正确
| 姓名   | W1  | W2  | W3  | ← 错误
```

---

### Q3：任务类型无法识别

**原因**：任务代码不在预设列表中

**解决方案**：
1. 使用标准任务代码（见图例）
2. 或使用完整名称（如"Workshop", "Project"）
3. 或系统会自动将前2个字符作为代码

**自动识别规则**：
```
输入："WS"           → 识别为 Workshop
输入："Workshop"    → 识别为 Workshop (WS)
输入："BPS Meeting" → 识别为 Meeting (M)
输入："ABC"         → 识别为 Others (AB)
```

---

### Q4：合并单元格未识别

**原因**：连续任务代码不一致

**解决方案**：
- 确保跨周任务使用相同的代码
- 例如：CW1=WS, CW2=WS, CW3=WS ✅
- 而不是：CW1=WS, CW2=ws, CW3=Workshop ❌

**⚠️ 注意**：
- 系统会自动将连续相同的代码识别为合并单元格
- 如果手动合并Excel单元格，系统也能识别

---

### Q5：导入后看不到数据

**原因1**：选择的年份不正确

**解决方案**：
- 确保导入时选择的年份与Excel数据匹配
- 例如：CW1-CW53 对应2025年，选择年份应为2025

**原因2**：数据在旧版本中

**解决方案**：
- 系统只显示最新版本的数据
- 如果最新导入失败，会显示上一个版本
- 查看导入历史，确认最新批次

---

## 📊 数据逻辑说明

### 版本追踪机制

```
数据库表结构：
┌──────┬─────────┬─────────┬──────────┬─────────────┐
│ ID   │ 员工    │ 任务    │ 周数     │ 导入时间    │
├──────┼─────────┼─────────┼──────────┼─────────────┤
│ 1    │ 王宁    │ WS      │ CW1      │ 2025-01-10  │ ← 旧版本
│ 2    │ 王宁    │ P       │ CW1      │ 2025-01-15  │ ← 最新版本
│ 3    │ 李华    │ T       │ CW2      │ 2025-01-15  │
└──────┴─────────┴─────────┴──────────┴─────────────┘

查询最新版本：
SELECT * FROM view_resource_planning_latest
WHERE employee_name = '王宁' AND start_week = 'CW1';
→ 返回 ID=2 的记录（Project）
```

---

### 周数转日期

```
周数格式：CW23（Calendar Week 23）
转换规则：ISO 8601标准

示例：
CW1  (2025) → 2024-12-30 到 2025-01-05
CW23 (2025) → 2025-06-02 到 2025-06-08
CW52 (2025) → 2025-12-22 到 2025-12-28
```

**⚠️ 注意**：
- 年初的第1周可能从上年12月开始
- 年末的第52/53周可能跨越到下年1月
- 系统会自动处理这些边界情况

---

### 跨周任务计算

```
示例：CW1-CW3 Workshop

解析结果：
- start_week: "CW1"
- end_week: "CW3"
- start_date: "2024-12-30"
- end_date: "2025-01-12"
- 周数跨度: 3周
- 天数: 14天
```

---

## 🎯 最佳实践

### 1. Excel文件准备

✅ **推荐**：
- 使用模板（点击"下载模板"）
- 清晰的列标题（CW1, CW2...）
- 标准的员工姓名（与系统一致）
- 统一的任务代码

❌ **避免**：
- 合并表头单元格
- 使用自定义周数格式
- 员工姓名不一致
- 混合使用代码和全名

---

### 2. 定期导入

建议频率：
- **每周导入**：更新最新的任务安排
- **每月归档**：保留历史版本供查阅
- **季度回顾**：分析资源利用率

---

### 3. 数据验证

导入后检查：
- ✅ 导入任务数量是否正确
- ✅ 警告信息中的未匹配员工
- ✅ 任务类型是否正确识别
- ✅ 日期范围是否合理

---

## 📁 文件结构

### 数据库文件
```
RESOURCE_PLANNING_DATABASE_SCHEMA.sql
├── resource_task_types 表（11种任务类型）
├── resource_planning_tasks 表（任务数据）
├── view_resource_planning_latest 视图（最新版本）
├── 索引和约束
└── RLS安全策略
```

### 前端文件
```
src/
├── lib/
│   ├── excelResourceParser.ts（Excel解析）
│   ├── supabaseService.ts（API服务）
│   └── database.types.ts（类型定义）
└── pages/
    └── ResourcePlanning.tsx（导入页面）
```

---

## 🔗 相关文档

- [数据库Schema详细说明](./RESOURCE_PLANNING_DATABASE_SCHEMA.sql)
- [Excel解析工具API](./src/lib/excelResourceParser.ts)
- [Supabase API文档](./src/lib/supabaseService.ts)

---

## 📞 技术支持

### 问题反馈

如遇到问题，请提供：
1. Excel文件样本（脱敏后）
2. 错误截图
3. 浏览器控制台日志
4. 导入时间和批次ID

### 常用查询

```sql
-- 查询导入历史
SELECT DISTINCT import_batch_id, source_file_name, imported_at, COUNT(*) as count
FROM resource_planning_tasks
GROUP BY import_batch_id, source_file_name, imported_at
ORDER BY imported_at DESC;

-- 查询最新任务
SELECT * FROM view_resource_planning_latest
WHERE employee_name = '王宁'
ORDER BY start_date;

-- 查询任务类型分布
SELECT task_type_code, COUNT(*) as count
FROM view_resource_planning_latest
GROUP BY task_type_code
ORDER BY count DESC;
```

---

**祝使用愉快！** 🎊

如有任何问题，请随时反馈！ 💬
