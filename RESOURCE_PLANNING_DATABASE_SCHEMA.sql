-- ============================================================================
-- èµ„æºè§„åˆ’æ¨¡å—æ•°æ®åº“Schema
-- Resource Planning Module Database Schema
-- ============================================================================
-- åˆ›å»ºæ—¥æœŸ: 2025-11-24
-- è¯´æ˜: ç‹¬ç«‹çš„èµ„æºè§„åˆ’è¡¨ç»“æ„ï¼Œç”¨äºå­˜å‚¨Excelå¯¼å…¥çš„ä»»åŠ¡æ•°æ®
-- ç‰¹æ€§: è¿½åŠ æ¨¡å¼ã€ç‰ˆæœ¬è¿½è¸ªã€æœ€æ–°çŠ¶æ€æ˜¾ç¤º
-- ============================================================================

-- ============================================================================
-- 1. èµ„æºè§„åˆ’ä»»åŠ¡ç±»å‹è¡¨ (Resource Task Types)
-- ============================================================================
-- è¯´æ˜: å­˜å‚¨Excelä¸­çš„ä»»åŠ¡ç±»å‹æ˜ å°„ï¼ˆé¢œè‰²+ç¼©å†™ï¼‰
-- ç‰¹ç‚¹: ç‹¬ç«‹äºScheduleæ¨¡å—çš„task_typesè¡¨
CREATE TABLE IF NOT EXISTS resource_task_types (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  code TEXT UNIQUE NOT NULL,        -- ç¼©å†™ä»£ç  (å¦‚: "WS", "P", "T")
  name TEXT NOT NULL,               -- å®Œæ•´åç§°
  color_hex TEXT NOT NULL,          -- åå…­è¿›åˆ¶é¢œè‰² (é«˜å¯è¯»æ€§)
  description TEXT,                 -- æè¿°
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- æ·»åŠ æ³¨é‡Š
COMMENT ON TABLE resource_task_types IS 'èµ„æºè§„åˆ’ä»»åŠ¡ç±»å‹é…ç½®è¡¨';
COMMENT ON COLUMN resource_task_types.code IS 'ä»»åŠ¡ç±»å‹ç¼©å†™ä»£ç  (ç”¨äºExcelè§£æ)';
COMMENT ON COLUMN resource_task_types.color_hex IS 'ä»»åŠ¡ç±»å‹é¢œè‰² (åå…­è¿›åˆ¶)';

-- ============================================================================
-- 2. èµ„æºè§„åˆ’ä»»åŠ¡è¡¨ (Resource Planning Tasks)
-- ============================================================================
-- è¯´æ˜: å­˜å‚¨ä»Excelå¯¼å…¥çš„å®é™…ä»»åŠ¡æ•°æ®
-- ç‰¹ç‚¹: æ”¯æŒåˆå¹¶å•å…ƒæ ¼ï¼ˆè·¨å‘¨ä»»åŠ¡ï¼‰ã€ç‰ˆæœ¬è¿½è¸ªã€è¿½åŠ æ¨¡å¼
CREATE TABLE IF NOT EXISTS resource_planning_tasks (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  
  -- å…³è”å…³ç³»
  employee_id UUID REFERENCES employees(id) NOT NULL,
  task_type_code TEXT NOT NULL,     -- ç›´æ¥å­˜å‚¨ä»£ç ï¼Œä¾¿äºå¿«é€ŸæŸ¥è¯¢
  
  -- æ—¶é—´èŒƒå›´ï¼ˆå…³é”®ï¼šå¤„ç†åˆå¹¶å•å…ƒæ ¼ï¼‰
  start_week TEXT NOT NULL,         -- ExcelåŸå§‹å‘¨æ•° "CW23"
  end_week TEXT NOT NULL,           -- ExcelåŸå§‹å‘¨æ•° "CW25"
  start_date DATE NOT NULL,         -- è®¡ç®—å‡ºçš„å¼€å§‹æ—¥æœŸ
  end_date DATE NOT NULL,           -- è®¡ç®—å‡ºçš„ç»“æŸæ—¥æœŸ
  
  -- ä»»åŠ¡è¯¦æƒ…
  topic TEXT,                       -- Excelå•å…ƒæ ¼ä¸­çš„å…·ä½“æ–‡å­—ï¼ˆå¯é€‰ï¼‰
  location TEXT,                    -- ä»»åŠ¡åœ°ç‚¹ï¼ˆå¯é€‰ï¼‰
  notes TEXT,                       -- å¤‡æ³¨ä¿¡æ¯
  
  -- ç‰ˆæœ¬è¿½è¸ªï¼ˆå…³é”®ï¼šæ”¯æŒè¿½åŠ å’Œæ˜¾ç¤ºæœ€æ–°ï¼‰
  imported_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),  -- å¯¼å…¥æ—¶é—´æˆ³ï¼ˆåˆ¤æ–­æœ€æ–°ï¼‰
  import_batch_id UUID,             -- åŒä¸€æ¬¡å¯¼å…¥çš„æ‰¹æ¬¡ID
  source_file_name TEXT,            -- æ¥æºExcelæ–‡ä»¶å
  
  -- å…ƒæ•°æ®
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- æ·»åŠ æ³¨é‡Š
COMMENT ON TABLE resource_planning_tasks IS 'èµ„æºè§„åˆ’ä»»åŠ¡æ•°æ®è¡¨';
COMMENT ON COLUMN resource_planning_tasks.start_week IS 'ExcelåŸå§‹å‘¨æ•°æ ¼å¼ (å¦‚: CW23)';
COMMENT ON COLUMN resource_planning_tasks.end_week IS 'ExcelåŸå§‹å‘¨æ•°æ ¼å¼ (å¦‚: CW25)ï¼Œæ”¯æŒåˆå¹¶å•å…ƒæ ¼';
COMMENT ON COLUMN resource_planning_tasks.imported_at IS 'å¯¼å…¥æ—¶é—´æˆ³ï¼Œç”¨äºåˆ¤æ–­æœ€æ–°ç‰ˆæœ¬';
COMMENT ON COLUMN resource_planning_tasks.import_batch_id IS 'æ‰¹æ¬¡IDï¼Œç”¨äºè¿½è¸ªåŒä¸€æ¬¡å¯¼å…¥çš„æ‰€æœ‰ä»»åŠ¡';

-- ============================================================================
-- 3. ç´¢å¼•ä¼˜åŒ–
-- ============================================================================
-- æé«˜æŸ¥è¯¢æ€§èƒ½

-- æŒ‰å‘˜å·¥æŸ¥è¯¢ï¼ˆæœ€å¸¸ç”¨ï¼‰
CREATE INDEX IF NOT EXISTS idx_resource_tasks_employee 
  ON resource_planning_tasks(employee_id);

-- æŒ‰æ—¥æœŸèŒƒå›´æŸ¥è¯¢
CREATE INDEX IF NOT EXISTS idx_resource_tasks_dates 
  ON resource_planning_tasks(start_date, end_date);

-- æŒ‰å¯¼å…¥æ—¶é—´æ’åºï¼ˆè·å–æœ€æ–°ç‰ˆæœ¬ï¼‰
CREATE INDEX IF NOT EXISTS idx_resource_tasks_imported_at 
  ON resource_planning_tasks(imported_at DESC);

-- æŒ‰æ‰¹æ¬¡æŸ¥è¯¢
CREATE INDEX IF NOT EXISTS idx_resource_tasks_batch 
  ON resource_planning_tasks(import_batch_id);

-- æŒ‰ä»»åŠ¡ç±»å‹æŸ¥è¯¢
CREATE INDEX IF NOT EXISTS idx_resource_tasks_type 
  ON resource_planning_tasks(task_type_code);

-- å¤åˆç´¢å¼•ï¼šå‘˜å·¥+æ—¶é—´ï¼ˆé«˜é¢‘æŸ¥è¯¢ï¼‰
CREATE INDEX IF NOT EXISTS idx_resource_tasks_emp_date 
  ON resource_planning_tasks(employee_id, start_date, end_date);

-- ============================================================================
-- 4. è§¦å‘å™¨ï¼šè‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³
-- ============================================================================
CREATE OR REPLACE FUNCTION update_resource_task_timestamp()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_update_resource_task_timestamp ON resource_planning_tasks;
CREATE TRIGGER trigger_update_resource_task_timestamp
  BEFORE UPDATE ON resource_planning_tasks
  FOR EACH ROW
  EXECUTE FUNCTION update_resource_task_timestamp();

-- ============================================================================
-- 5. è§†å›¾ï¼šè·å–æœ€æ–°ç‰ˆæœ¬çš„ä»»åŠ¡
-- ============================================================================
-- è¯´æ˜: è¿™ä¸ªè§†å›¾è‡ªåŠ¨ç­›é€‰å‡ºæ¯ä¸ªå‘˜å·¥+æ—¶é—´æ®µçš„æœ€æ–°ä»»åŠ¡ç‰ˆæœ¬
CREATE OR REPLACE VIEW view_resource_planning_latest AS
WITH ranked_tasks AS (
  SELECT 
    rpt.*,
    rtt.name AS task_type_name,
    rtt.color_hex AS task_type_color,
    e.name AS employee_name,
    e.employee_id AS employee_code,
    d.name AS department_name,
    ROW_NUMBER() OVER (
      PARTITION BY rpt.employee_id, rpt.start_week, rpt.end_week, rpt.task_type_code
      ORDER BY rpt.imported_at DESC
    ) AS rn
  FROM resource_planning_tasks rpt
  LEFT JOIN resource_task_types rtt ON rpt.task_type_code = rtt.code
  LEFT JOIN employees e ON rpt.employee_id = e.id
  LEFT JOIN departments d ON e.department_id = d.id
)
SELECT 
  id,
  employee_id,
  employee_name,
  employee_code,
  department_name,
  task_type_code,
  task_type_name,
  task_type_color,
  start_week,
  end_week,
  start_date,
  end_date,
  topic,
  location,
  notes,
  imported_at,
  import_batch_id,
  source_file_name,
  created_at,
  updated_at
FROM ranked_tasks
WHERE rn = 1;

COMMENT ON VIEW view_resource_planning_latest IS 'èµ„æºè§„åˆ’æœ€æ–°ç‰ˆæœ¬ä»»åŠ¡è§†å›¾';

-- ============================================================================
-- 6. RLSå®‰å…¨ç­–ç•¥
-- ============================================================================
-- å¯ç”¨è¡Œçº§å®‰å…¨
ALTER TABLE resource_task_types ENABLE ROW LEVEL SECURITY;
ALTER TABLE resource_planning_tasks ENABLE ROW LEVEL SECURITY;

-- ä»»åŠ¡ç±»å‹è¡¨ï¼šæ‰€æœ‰è®¤è¯ç”¨æˆ·å¯è¯»
DROP POLICY IF EXISTS "Allow authenticated users to read resource_task_types" ON resource_task_types;
CREATE POLICY "Allow authenticated users to read resource_task_types"
  ON resource_task_types FOR SELECT
  TO authenticated
  USING (true);

-- ä»»åŠ¡è¡¨ï¼šæ‰€æœ‰è®¤è¯ç”¨æˆ·å¯è¯»
DROP POLICY IF EXISTS "Allow authenticated users to read resource_planning_tasks" ON resource_planning_tasks;
CREATE POLICY "Allow authenticated users to read resource_planning_tasks"
  ON resource_planning_tasks FOR SELECT
  TO authenticated
  USING (true);

-- ä»»åŠ¡è¡¨ï¼šæ‰€æœ‰è®¤è¯ç”¨æˆ·å¯æ’å…¥ï¼ˆå¯¼å…¥åŠŸèƒ½ï¼‰
DROP POLICY IF EXISTS "Allow authenticated users to insert resource_planning_tasks" ON resource_planning_tasks;
CREATE POLICY "Allow authenticated users to insert resource_planning_tasks"
  ON resource_planning_tasks FOR INSERT
  TO authenticated
  WITH CHECK (true);

-- ä»»åŠ¡è¡¨ï¼šæ‰€æœ‰è®¤è¯ç”¨æˆ·å¯æ›´æ–°
DROP POLICY IF EXISTS "Allow authenticated users to update resource_planning_tasks" ON resource_planning_tasks;
CREATE POLICY "Allow authenticated users to update resource_planning_tasks"
  ON resource_planning_tasks FOR UPDATE
  TO authenticated
  USING (true)
  WITH CHECK (true);

-- ============================================================================
-- 7. é¢„è®¾ä»»åŠ¡ç±»å‹æ•°æ®ï¼ˆé«˜å¯è¯»æ€§é¢œè‰²ï¼‰
-- ============================================================================
-- è¯´æ˜: åŸºäºExcelå¸¸è§ä»»åŠ¡ç±»å‹ï¼Œä½¿ç”¨é«˜å¯¹æ¯”åº¦ã€æ˜“åŒºåˆ†çš„é¢œè‰²
INSERT INTO resource_task_types (code, name, color_hex, description) VALUES
  ('WS', 'Workshop', '#3B82F6', 'ç ”è®¨ä¼š/å·¥ä½œåŠ - è“è‰²'),
  ('SW', 'Speed Week', '#8B5CF6', 'å¿«é€Ÿå‘¨æ”¹å–„æ´»åŠ¨ - ç´«è‰²'),
  ('P', 'Project', '#10B981', 'é¡¹ç›®å®æ–½ - ç»¿è‰²'),
  ('T', 'Training', '#F59E0B', 'åŸ¹è®­è¯¾ç¨‹ - æ©™è‰²'),
  ('C', 'Coaching', '#EF4444', 'è¾…å¯¼æŒ‡å¯¼ - çº¢è‰²'),
  ('M', 'Meeting', '#6366F1', 'ä¼šè®® - é›è“è‰²'),
  ('L', 'Leave', '#64748B', 'ä¼‘å‡ - ç°è‰²'),
  ('SD', 'Self-Develop', '#14B8A6', 'è‡ªæˆ‘å‘å±• - é’è‰²'),
  ('A', 'Assessment', '#EC4899', 'è¯„ä¼°å®¡æ ¸ - ç²‰è‰²'),
  ('S', 'Support', '#06B6D4', 'ç°åœºæ”¯æŒ - å¤©è“è‰²'),
  ('O', 'Others', '#9CA3AF', 'å…¶ä»– - æµ…ç°è‰²')
ON CONFLICT (code) DO NOTHING;

-- ============================================================================
-- 8. è¾…åŠ©å‡½æ•°ï¼šå‘¨æ•°è½¬æ—¥æœŸ
-- ============================================================================
-- è¯´æ˜: å°† "CW23" æ ¼å¼è½¬æ¢ä¸ºæ—¥æœŸ
-- ç¤ºä¾‹: week_to_date('CW23', 2025) -> '2025-06-02'
CREATE OR REPLACE FUNCTION week_to_date(week_str TEXT, year INT DEFAULT EXTRACT(YEAR FROM CURRENT_DATE)::INT)
RETURNS DATE AS $$
DECLARE
  week_num INT;
BEGIN
  -- æå–å‘¨æ•°ï¼ˆå»æ‰"CW"å‰ç¼€ï¼‰
  week_num := SUBSTRING(week_str FROM 3)::INT;
  
  -- è®¡ç®—è¯¥å¹´ç¬¬ä¸€å‘¨çš„å¼€å§‹æ—¥æœŸï¼Œç„¶ååŠ ä¸Šç›¸åº”çš„å‘¨æ•°
  RETURN DATE_TRUNC('week', MAKE_DATE(year, 1, 4)) + (week_num - 1) * INTERVAL '1 week';
END;
$$ LANGUAGE plpgsql IMMUTABLE;

COMMENT ON FUNCTION week_to_date IS 'å°†CWæ ¼å¼å‘¨æ•°è½¬æ¢ä¸ºæ—¥æœŸ';

-- ============================================================================
-- 9. è¾…åŠ©å‡½æ•°ï¼šæ‰¹é‡æ’å…¥åŠ©æ‰‹
-- ============================================================================
-- è¯´æ˜: ç”¨äºæ‰¹é‡æ’å…¥ä»»åŠ¡æ—¶è‡ªåŠ¨ç”Ÿæˆæ‰¹æ¬¡ID
CREATE OR REPLACE FUNCTION generate_import_batch_id()
RETURNS UUID AS $$
BEGIN
  RETURN gen_random_uuid();
END;
$$ LANGUAGE plpgsql VOLATILE;

-- ============================================================================
-- 10. éªŒè¯æ•°æ®å®Œæ•´æ€§
-- ============================================================================
-- æ·»åŠ çº¦æŸï¼šç¡®ä¿å‘¨æ•°æ ¼å¼æ­£ç¡®
ALTER TABLE resource_planning_tasks 
  ADD CONSTRAINT check_week_format 
  CHECK (start_week ~ '^CW\d{1,2}$' AND end_week ~ '^CW\d{1,2}$');

-- æ·»åŠ çº¦æŸï¼šç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸ
ALTER TABLE resource_planning_tasks 
  ADD CONSTRAINT check_date_order 
  CHECK (end_date >= start_date);

-- ============================================================================
-- å®Œæˆæç¤º
-- ============================================================================
DO $$
BEGIN
  RAISE NOTICE 'âœ… Resource Planning Database Schema Created Successfully!';
  RAISE NOTICE 'ğŸ“Š Tables: resource_task_types, resource_planning_tasks';
  RAISE NOTICE 'ğŸ” View: view_resource_planning_latest';
  RAISE NOTICE 'ğŸ¨ Preset Task Types: 11 types with high-readability colors';
  RAISE NOTICE 'ğŸ” RLS Policies: Enabled for authenticated users';
  RAISE NOTICE 'âš¡ Indexes: Created for performance optimization';
  RAISE NOTICE '';
  RAISE NOTICE 'ğŸ“ Next Steps:';
  RAISE NOTICE '   1. Run this SQL in Supabase SQL Editor';
  RAISE NOTICE '   2. Update TypeScript types in database.types.ts';
  RAISE NOTICE '   3. Extend supabaseService.ts with API methods';
  RAISE NOTICE '   4. Create Excel parser utility';
  RAISE NOTICE '   5. Build Resource Planning Import UI';
END $$;
