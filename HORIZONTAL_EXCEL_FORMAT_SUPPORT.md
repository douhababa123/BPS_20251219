# 横向Excel格式支持文档

## 📅 更新日期
2025-11-24

## 🎯 需求背景

用户的Excel采用**横向格式**：
- **第一行**：部门、姓名、能力类型1、能力类型2、...
- **数据行**：每行代表一个人的所有能力评估
- **得分格式**：支持 `3/4`（现状/目标）或分开的 `能力-C`、`能力-T` 列

## 📊 支持的Excel格式

### 格式1：斜杠分隔（推荐） ✅

```
| 部门    | 姓名  | 需求分析 | 系统设计 | 编程   | 测试   |
|---------|-------|----------|----------|--------|--------|
| SCh-PS  | 张三  | 3/4      | 4/5      | 3/4    | 4/5    |
| SCh-QA  | 李四  | 2/3      | 3/4      | 2/3    | 3/4    |
```

**解释**：
- `3/4` = 现状得分3分，目标得分4分
- 简洁、直观、易于编辑

### 格式2：C/T分列 ✅

```
| 部门    | 姓名  | 需求分析-C | 需求分析-T | 系统设计-C | 系统设计-T |
|---------|-------|------------|------------|------------|------------|
| SCh-PS  | 张三  | 3          | 4          | 4          | 5          |
| SCh-QA  | 李四  | 2          | 3          | 3          | 4          |
```

**解释**：
- `-C` 或 `Current` 表示现状得分
- `-T` 或 `Target` 表示目标得分
- 适合详细分析场景

### 格式3：英文关键字 ✅

```
| Department | Name  | Requirements-Current | Requirements-Target | Design-Current | Design-Target |
|------------|-------|----------------------|---------------------|----------------|---------------|
| SCh-PS     | Zhang | 3                    | 4                   | 4              | 5             |
| SCh-QA     | Li    | 2                    | 3                   | 3              | 4             |
```

### 格式4：模块前缀 ✅

```
| 部门    | 姓名  | TPM基础-设备管理 | TPM基础-预防维护 | 精益流程-VSM | 精益流程-SMED |
|---------|-------|------------------|------------------|--------------|---------------|
| SCh-PS  | 张三  | 3/4              | 4/5              | 3/4          | 4/5           |
```

**解释**：
- `TPM基础-设备管理` 自动拆分为：
  - 模块名：TPM基础
  - 能力类型：设备管理

## 🔍 自动检测逻辑

### 格式检测规则

系统会自动判断Excel是横向还是纵向格式：

```typescript
// 检测逻辑
if (第一行包含"部门"或"姓名" && 第一行不包含"模块"或"类型") {
  → 横向格式
} else {
  → 纵向格式（传统格式）
}
```

### 示例对比

| 第一行内容 | 格式判断 | 原因 |
|-----------|----------|------|
| `部门 \| 姓名 \| 需求分析 \| 系统设计` | **横向** | 有个人信息，无模块/类型列 |
| `部门 \| 姓名 \| 模块 \| 类型 \| C \| T` | **纵向** | 有模块/类型列（传统格式） |
| `Department \| Name \| Skill1 \| Skill2` | **横向** | 有个人信息，其余是能力 |

## 🛠️ 解析流程

### 步骤1：识别固定列

查找以下列（不区分大小写，支持空格/下划线）：
- **部门列**：`部门`、`Department`、`Dept`
- **姓名列**：`姓名`、`Name`、`工程师`、`Engineer`

### 步骤2：识别能力类型列

从姓名列后的所有列都视为能力类型列。

对每个列标题进行分类：
- 包含 `C`、`Current`、`现状` → **现状得分列**
- 包含 `T`、`Target`、`目标` → **目标得分列**
- 其他 → **斜杠格式列**（期望格式 `3/4`）

### 步骤3：列配对

对于 `-C` 和 `-T` 列，自动配对：
```
需求分析-C + 需求分析-T → 配对成功
```

对于斜杠格式列，直接解析单元格内容：
```
"3/4" → Current: 3, Target: 4
```

### 步骤4：提取模块信息

从能力类型名称中提取模块：

#### 方法1：分隔符拆分
```
"TPM基础-设备管理" 
  → 模块: TPM基础
  → 类型: 设备管理

"精益流程/VSM"
  → 模块: 精益流程
  → 类型: VSM
```

支持的分隔符：`-`、`_`、`/`、`\`、`|`、`－`、`—`

#### 方法2：关键字识别
```
"设备管理" (没有分隔符)
  → 包含"设备" → 推断模块: 设备管理 (ID: 8)
  → 类型: 设备管理

"VSM分析"
  → 包含"流程" → 推断模块: 流程优化 (ID: 9)
  → 类型: VSM分析
```

#### 方法3：前缀匹配
```
"TPM基础设备维护" (紧密连接)
  → 以"TPM基础"开头 → 模块: TPM基础
  → 剩余部分 → 类型: 设备维护
```

### 步骤5：数据验证

对每个得分进行验证：
- ✅ 现状得分：1-5之间的整数
- ✅ 目标得分：1-5之间的整数
- ✅ 目标 ≥ 现状（允许相等）

### 步骤6：数据转换

将横向数据转换为数据库需要的纵向格式：

**Excel数据（横向）**：
```
| 部门   | 姓名  | 需求分析 | 系统设计 |
| SCh-PS | 张三  | 3/4      | 4/5      |
```

**转换为数据库格式（纵向）**：
```json
[
  {
    "department": "SCh-PS",
    "engineer_name": "张三",
    "engineer_id": "张三",
    "module_id": 3,
    "module_name": "问题解决",
    "competency_type": "需求分析",
    "current_score": 3,
    "target_score": 4,
    "gap": 1,
    "assessment_year": 2025
  },
  {
    "department": "SCh-PS",
    "engineer_name": "张三",
    "engineer_id": "张三",
    "module_id": 4,
    "module_name": "项目管理",
    "competency_type": "系统设计",
    "current_score": 4,
    "target_score": 5,
    "gap": 1,
    "assessment_year": 2025
  }
]
```

## ⚠️ 常见错误及解决

### 错误1：未找到部门/姓名列

**错误信息**：
```
横向格式：未找到"部门"和"姓名"列

实际列标题：
[0] Dept
[1] 工程师姓名
[2] 需求分析
...
```

**解决方案**：
- 确保第一列包含 `部门`、`Department`、`Dept` 等关键字
- 确保第二列包含 `姓名`、`Name`、`工程师` 等关键字
- 列名支持中英文、大小写不敏感、忽略空格/下划线

### 错误2：缺少配对的C/T列

**错误信息**：
```
Row 2, Field: 需求分析, Error: 能力"需求分析"只有现状得分，缺少目标得分
```

**原因**：
- 有 `需求分析-C` 列，但没有 `需求分析-T` 列

**解决方案**：
- 方案A：添加配对的 `-T` 列
- 方案B：改为斜杠格式 `3/4`

### 错误3：单个数字（无法判断现状/目标）

**错误信息**：
```
Row 2, Field: 需求分析, Error: 能力"需求分析"只有一个得分"3"，请使用"现状/目标"格式（如"3/4"）
```

**原因**：
- 单元格只有一个数字 `3`，无法区分是现状还是目标

**解决方案**：
- 方案A：使用斜杠格式 `3/4`
- 方案B：拆分为两列 `需求分析-C` 和 `需求分析-T`

### 错误4：得分超出范围

**错误信息**：
```
Row 2, Field: 需求分析, Error: 现状得分必须在1-5之间
```

**解决方案**：
- 检查Excel中的得分是否是1-5的整数
- 注意空格、特殊字符等

### 错误5：目标低于现状

**错误信息**：
```
Row 2, Field: 需求分析, Error: 目标得分(2)不能低于现状得分(3)
```

**解决方案**：
- 检查斜杠格式是否正确：`现状/目标`
- 确保目标得分 ≥ 现状得分

## 📝 Excel模板示例

### 推荐模板（斜杠格式）

```
| 部门        | 姓名   | TPM基础-设备管理 | TPM基础-预防维护 | 精益流程-VSM | 精益流程-SMED | 问题解决-8D | 项目管理-计划 |
|-------------|--------|------------------|------------------|--------------|---------------|-------------|---------------|
| SCh-PS      | 张三   | 3/4              | 4/5              | 3/4          | 4/5           | 3/4         | 4/5           |
| SCh-QA      | 李四   | 2/3              | 3/4              | 2/3          | 3/4           | 2/3         | 3/4           |
| SCh-Mfg     | 王五   | 4/5              | 5/5              | 4/5          | 5/5           | 4/5         | 5/5           |
```

**使用说明**：
1. 第一列必须是部门
2. 第二列必须是姓名
3. 从第三列开始，每列是一个能力类型
4. 能力类型名称建议格式：`模块名-能力名`
5. 得分格式：`现状得分/目标得分`（如 `3/4`）
6. 得分必须是1-5的整数
7. 目标得分 ≥ 现状得分

### 详细模板（C/T分列）

```
| 部门   | 姓名 | 设备管理-C | 设备管理-T | 预防维护-C | 预防维护-T | VSM-C | VSM-T |
|--------|------|------------|------------|------------|------------|-------|-------|
| SCh-PS | 张三 | 3          | 4          | 4          | 5          | 3     | 4     |
| SCh-QA | 李四 | 2          | 3          | 3          | 4          | 2     | 3     |
```

## 🔧 代码实现细节

### 文件：`src/lib/excelParser.ts`

#### 新增方法

1. **`detectExcelFormat()`**
   - 自动检测Excel格式（横向/纵向）
   - 返回：`'horizontal'` 或 `'vertical'`

2. **`parseHorizontalFormat()`**
   - 解析横向格式Excel
   - 处理C/T配对
   - 处理斜杠格式
   - 提取模块信息
   - 验证得分
   - 转换为数据库格式

3. **`parseVerticalFormat()`**
   - 原有的纵向格式解析逻辑
   - 保持向后兼容

4. **`parseScore()`**
   - 解析单个得分
   - 支持数字、字符串、空值

5. **`validateScores()`**
   - 验证得分范围（1-5）
   - 验证目标≥现状
   - 返回详细错误信息

6. **`parseCompetencyName()`**
   - 从能力名称中提取模块和类型
   - 支持多种分隔符
   - 智能识别模块关键字
   - 自动推断模块

#### 主流程

```typescript
static async parseCompetencyAssessments(file: File) {
  const rawData = await this.readExcelFile(file);
  
  // 1. 检测格式
  const format = this.detectExcelFormat(rawData);
  
  // 2. 根据格式选择解析方法
  if (format === 'horizontal') {
    return this.parseHorizontalFormat(rawData);
  } else {
    return this.parseVerticalFormat(rawData);
  }
}
```

## 🎯 模块映射表

| 模块名 | 模块ID | 英文名 | 关键字 |
|--------|--------|--------|--------|
| TPM基础 | 1 | TPM | TPM, 基础 |
| 精益流程 | 2 | Lean | Lean, 精益, 流程 |
| 问题解决 | 3 | Problem Solving | Problem, 问题, 解决 |
| 项目管理 | 4 | Project Management | Project, 项目, 管理 |
| 数据分析 | 5 | Data Analysis | Data, 数据, 分析 |
| 团队领导 | 6 | Leadership | Leader, 领导, 团队 |
| 质量管理 | 7 | Quality | Quality, 质量 |
| 设备管理 | 8 | Equipment | Equipment, 设备 |
| 流程优化 | 9 | Process | Process, 优化 |

## ✅ 测试场景

### 场景1：基本横向格式（斜杠）
```
部门 | 姓名 | 技能A | 技能B
SCh  | 张三 | 3/4   | 4/5
```
**预期**：✅ 成功解析2条记录

### 场景2：C/T分列格式
```
部门 | 姓名 | 技能A-C | 技能A-T
SCh  | 张三 | 3       | 4
```
**预期**：✅ 成功解析1条记录

### 场景3：混合格式
```
部门 | 姓名 | 技能A | 技能B-C | 技能B-T
SCh  | 张三 | 3/4   | 4       | 5
```
**预期**：✅ 成功解析2条记录

### 场景4：空格和换行
```
部门 | 姓名 | TPM 基础 | 精益\n流程
SCh  | 张三 | 3/4      | 4/5
```
**预期**：✅ 自动清理空格和换行，成功解析

### 场景5：英文格式
```
Department | Name  | Equipment-Current | Equipment-Target
SCh-PS     | Zhang | 3                 | 4
```
**预期**：✅ 支持英文关键字，成功解析

### 场景6：模块前缀
```
部门 | 姓名 | TPM基础-设备 | 精益流程-VSM
SCh  | 张三 | 3/4          | 4/5
```
**预期**：✅ 自动拆分模块和能力，成功解析

## 🚀 用户指南

### 快速开始

1. **准备Excel**
   - 第一行：部门、姓名、能力类型1、能力类型2、...
   - 数据行：每行一个人的所有能力评估
   - 得分：使用 `3/4` 格式

2. **上传文件**
   - 进入"数据导入"页面
   - 选择"能力评估"
   - 上传Excel文件

3. **检查结果**
   - 系统自动检测格式
   - 显示解析结果
   - 如有错误，查看详细提示

4. **确认导入**
   - 确认无误后，点击"确认导入"
   - 数据将覆盖现有数据

### 最佳实践

✅ **推荐做法**：
- 使用斜杠格式 `3/4`（简洁）
- 能力名称包含模块前缀（如 `TPM基础-设备管理`）
- 列名清晰、无特殊字符
- 得分为1-5整数

❌ **避免的做法**：
- 单个数字（如只写 `3`）
- 得分超出1-5范围
- 目标低于现状
- C/T列不配对

## 📚 相关文档

- [EXCEL_PARSER_IMPROVEMENTS.md](./EXCEL_PARSER_IMPROVEMENTS.md) - 列名识别优化
- [IMPORT_ERROR_ANALYSIS.md](./IMPORT_ERROR_ANALYSIS.md) - 错误分析
- [SUPABASE_INTEGRATION_CHANGELOG.md](./SUPABASE_INTEGRATION_CHANGELOG.md) - 数据库集成

---

*最后更新：2025-11-24*
