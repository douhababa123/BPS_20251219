# 🚀 资源规划导入V2 - 快速上手

## ✅ 完成状态

**状态**：✅ 100%完成  
**日期**：2025-11-24  
**版本**：V2（按天存储版本）

---

## ⚠️ 重要：需要先更新数据库

### 第1步：执行SQL更新脚本（必须！）

```bash
1. 打开 Supabase Dashboard
2. 进入 SQL Editor
3. 复制粘贴下面文件的全部内容：
   📄 RESOURCE_PLANNING_DATABASE_SCHEMA_V2.sql
4. 点击 RUN ▶️
5. 等待成功提示
```

**这个脚本会**：
- ✅ 添加新字段：`task_date`, `year_month`, `cw_week`, `day_of_month`, `task_type`
- ✅ 创建新索引（提高查询性能）
- ✅ 更新视图（支持按天查询最新版本）
- ✅ 添加触发器（自动填充年月周字段）

---

## 🚀 使用流程（3步）

### 第2步：启动应用

```bash
npm run dev
```

### 第3步：导入Excel

```bash
1. 访问 http://localhost:5173
2. 点击左侧"数据导入"
3. 选择"📅 资源规划"（紫色卡片）
4. 选择年份（如2025）
5. 上传Excel文件
6. 查看控制台日志（按F12）
7. 查看导入结果！
```

---

## 📋 Excel格式要求

### 完整结构

```
┌─────────┬─────────┬──────────────────────────────────────┐
│ A列     │ B列     │ C列开始（每天一列）                  │
├─────────┼─────────┼──────────────────────────────────────┤
│ Name    │         │ Jan' 2025 (合并) │ Feb 2025 (合并) │ 第1行
│ (合并)  │         │ CW1│CW2│CW3│CW4 │ CW5│CW6│CW7│CW8│  │ 第2行
│         │         │ 1│2│3│8│9│10│15│16│1│2│3│8│9│10│  │ 第3行
├─────────┼─────────┼──┴─┴─┴──┴─┴──┴──┴──┴─┴─┴─┴─┴─┴──┤
│ 王宁    │ TOPIC   │会议│ │项目│ │ │培训│ │ │ │ │ │  │ 第4行
│ (合并   │ TYPE    │ M  │ │ P  │ │ │ T  │ │ │ │ │ │  │ 第5行
│ 3行)    │LOCATION │FLCNa││FCGNa│││EA │ │ │ │ │ │  │ 第6行
├─────────┼─────────┼────┴─┴────┴─┴─┴────┴─┴─┴─┴─┴─┴──┤
│ 李华    │ TOPIC   │ │培训│培训│ │ │ │ │ │ │ │ │ │  │ 第7行
│ (合并   │ TYPE    │ │ T  │ T  │ │ │ │ │ │ │ │ │ │  │ 第8行
│ 3行)    │LOCATION │ │FLCCh│FLCCh│ │ │ │ │ │ │ │ │ │  │ 第9行
└─────────┴─────────┴────────────────────────────────────┘
```

### 关键要点

1. **第1行**：年月（Jan' 2025, February 2025...）
2. **第2行**：CW周数（CW1, CW2...，可以合并单元格）
3. **第3行**：Day（1, 2, 3...，每天一列）
4. **A列**：工程师姓名（每3行合并一次）
5. **B列**：标签（TOPIC, TYPE, LOCATION循环）
6. **C列开始**：每天的任务数据

---

## 🎨 任务类型代码（在TYPE行使用）

| 代码 | 名称 | 颜色 |
|------|------|------|
| WS | Workshop | 蓝色 |
| SW | Speed Week | 紫色 |
| P | Project | 绿色 |
| T | Training | 橙色 |
| C | Coaching | 红色 |
| M | Meeting | 靛蓝 |
| L | Leave | 灰色 |
| SD | Self-Develop | 青色 |
| A | Assessment | 粉色 |
| S | Support | 天蓝 |
| O | Others | 浅灰 |

---

## 📊 数据存储逻辑

### 示例：王宁1月1日有会议

**Excel数据**：
```
A4: 王宁
B4: TOPIC    → C4: 会议
B5: TYPE     → C5: M
B6: LOCATION → C6: FLCNa
```

**存储为1条记录**：
```json
{
  "employee_id": "uuid-xxx",
  "task_date": "2025-01-01",
  "year_month": "2025-01",
  "cw_week": "CW01",
  "day_of_month": 1,
  "topic": "会议",
  "task_type": "M",
  "location": "FLCNa"
}
```

---

### 示例：王宁1月1-3日都是项目

**Excel数据**：
```
1月1日: P
1月2日: P
1月3日: P
```

**存储为3条记录**：
```json
[
  { "task_date": "2025-01-01", "task_type": "P", ... },
  { "task_date": "2025-01-02", "task_type": "P", ... },
  { "task_date": "2025-01-03", "task_type": "P", ... }
]
```

**显示时**：智能合并为1个跨3天的色块

---

## 🔍 控制台调试日志

导入时，按F12打开控制台，您会看到：

```
📂 开始解析Excel文件: 资源规划2025.xlsx
📊 Excel总行数: 50
📋 前3行数据:
  第1行（年月）: ['Name', '', 'Jan 2025', ...]
  第2行（CW周）: ['', '', 'CW1', 'CW1', ...]
  第3行（Day）: ['', '', '1', '2', '3', ...]
🔍 开始解析日期列...
📅 解析到 365 个日期列
👥 开始解析员工分组...
  ✅ 工程师: 王宁 (行4-6)
  ✅ 工程师: 李华 (行7-9)
📊 共找到 10 个工程师
✅ 解析完成，总任务数: 1250
```

---

## ⚠️ 常见问题

### Q1：导入失败 - "未找到员工"

**原因**：Excel中的员工姓名与数据库不匹配

**解决**：
1. 确保员工已在系统中（通过"能力评估"导入）
2. 检查姓名拼写（区分大小写）
3. 查看控制台日志中的警告

---

### Q2：导入成功但任务数为0

**原因**：TYPE行没有数据

**解决**：
- 确保TYPE行（B5, B8, B11...）有值
- 即使TOPIC和LOCATION为空，TYPE必须有值

---

### Q3：日期解析错误

**原因**：第1行的年月格式不标准

**解决**：
- 支持格式：`Jan' 2025`, `January 2025`, `2025-01`
- 确保第1行有年月信息

---

## 📝 测试清单

导入后检查：

- [ ] 控制台显示"✅ 解析完成"
- [ ] 导入任务数 > 0
- [ ] 警告信息中的未匹配员工（需要处理）
- [ ] 在Supabase中查询数据：
```sql
SELECT * FROM view_resource_planning_latest
WHERE employee_name = '王宁'
ORDER BY task_date
LIMIT 10;
```

---

## 🎉 完成！

现在您的资源规划导入已支持复杂的Excel结构！

### 立即开始：

```bash
# 1. 更新数据库
在Supabase执行：RESOURCE_PLANNING_DATABASE_SCHEMA_V2.sql

# 2. 启动应用
npm run dev

# 3. 开始导入
访问"数据导入" → 选择"资源规划" → 上传Excel
```

**祝使用愉快！** 🚀
