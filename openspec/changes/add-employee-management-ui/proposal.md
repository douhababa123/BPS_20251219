# Change: 添加员工信息管理界面

## Why

当前系统缺乏可视化的员工信息管理功能，导致以下问题：

1. **数据维护困难**：新员工入职、员工信息变更（部门调动、角色变更）需要直接操作数据库，门槛高且易出错
2. **无法自助管理**：HR 或管理员无法通过界面自主维护员工数据，必须依赖技术人员执行 SQL
3. **缺乏数据验证**：直接 SQL 操作缺少数据校验，可能导致数据不一致（如工号重复、无效部门等）
4. **影响其他模块**：员工信息是日程管理、能力评估等模块的基础数据，维护不便会影响整体使用体验

**实际案例**：在配置 `enhance-schedule-and-competency` 变更时，发现 Liu Kui 的员工信息缺失，需要手动编写 SQL 添加，体验不佳。

## What Changes

### 新增员工管理页面（Employee Management）

1. **员工列表视图**
   - 表格展示所有员工（分页加载，每页 50 条）
   - 列：工号、姓名、部门、职位、角色权限、在职状态、操作按钮
   - 支持按姓名、工号、部门搜索
   - 支持按角色、在职状态筛选
   - 支持按工号、姓名、部门排序

2. **添加员工功能**
   - 表单界面：工号、姓名、部门（下拉选择）、邮箱、职位、角色权限（单选）
   - 自动生成工号建议（可选，基于部门前缀 + 序号）
   - 实时校验：工号唯一性、邮箱格式、必填字段
   - 默认设置为在职状态（is_active = true）

3. **编辑员工信息**
   - 点击表格中的「编辑」按钮打开编辑表单
   - 可修改除工号外的所有字段（工号作为唯一标识不可修改）
   - 支持修改角色权限（BPS_ENGINEER ↔ SITE_PS）
   - 支持设置在职/离职状态

4. **删除/停用员工**
   - 软删除：设置 `is_active = false`（推荐，保留历史数据）
   - 硬删除：物理删除记录（仅管理员，需二次确认）
   - 删除前检查关联数据（日程任务、能力评估），如有关联则仅允许软删除

5. **批量导入**（可选，第二阶段）
   - Excel 文件上传（.xlsx/.xls）
   - 模板下载（包含必填字段说明）
   - 数据预览和验证
   - 错误报告下载

6. **操作日志**（可选，第二阶段）
   - 记录谁在什么时间做了什么操作（添加/修改/删除员工）
   - 支持审计和回溯

## Impact

### Affected Specs
- **新增能力**：`employee-management` - 员工信息管理（CRUD + 批量导入）

### Affected Code

#### 新增文件
- `src/pages/EmployeeManagement.tsx` - 员工管理页面主组件
- `src/components/EmployeeForm.tsx` - 员工信息表单（新增/编辑复用）
- `src/components/EmployeeTable.tsx` - 员工列表表格组件
- `src/components/EmployeeImport.tsx` - 批量导入组件（可选）

#### 修改文件
- `src/App.tsx` - 添加新路由
- `src/components/Sidebar.tsx` - 添加菜单项「员工管理」
- `src/lib/supabaseService.ts` - 增加员工 CRUD 方法

#### 数据库变更
- 无 Schema 变更（使用现有 `employees` 表）
- 可选：创建 `employee_change_logs` 表（操作日志）

### User Experience Impact
- ✅ 正面影响：HR 和管理员可自主维护员工信息，无需技术支持
- ✅ 数据质量提升：表单校验减少数据错误
- ✅ 透明度提升：操作日志增强可追溯性

### Security Considerations
- 仅 `SITE_PS` 和 `ADMIN` 角色可访问员工管理页面
- 普通 `BPS_ENGINEER` 用户无权查看或修改员工信息
- 角色权限修改需要记录操作日志

## Dependencies

### 依赖的变更
- ✅ `enhance-schedule-and-competency` - 必须先完成，确保 `employees.role` 字段存在

### 前置条件
- ✅ 数据库中 `employees` 表已包含 `role` 字段
- ✅ 权限系统已实现（AuthContext 支持角色判断）

## Migration & Rollback

### 数据迁移
- 无需数据迁移（使用现有表结构）
- 如果增加操作日志，需创建 `employee_change_logs` 表

### 回滚方案
- 移除新增的菜单项和路由
- 删除新增的页面组件
- 如创建了日志表，可选择保留或删除

## Risks & Mitigation

### 风险1：权限校验不完善导致未授权访问
- **影响**：普通用户可能绕过前端限制访问员工数据
- **缓解**：
  - 前端 UI 层隐藏菜单入口
  - 路由守卫检查用户角色
  - Supabase RLS 策略限制数据库访问（双重保护）

### 风险2：删除员工导致关联数据孤立
- **影响**：删除员工后，历史日程任务和能力评估可能找不到关联员工
- **缓解**：
  - 默认使用软删除（`is_active = false`）
  - 硬删除前检查关联数据，如有则禁止删除或提示用户
  - 数据库外键设置为 `ON DELETE SET NULL`（已有配置）

### 风险3：批量导入数据质量问题
- **影响**：Excel 导入可能包含格式错误、重复数据
- **缓解**：
  - 严格的数据验证（工号唯一性、必填字段、邮箱格式）
  - 导入前预览和确认
  - 失败记录可导出为错误报告

## Open Questions

1. **角色权限粒度**：是否需要更细粒度的权限？
   - 例如：HR 可以添加/编辑员工，但不能修改角色权限
   - 例如：部门主管可以查看本部门员工，但不能编辑
   - **建议**：第一阶段保持简单（SITE_PS 和 ADMIN 全权限），后续根据需求扩展

2. **员工工号生成规则**：是否需要自动生成工号？
   - 当前格式：`SWa-PS_Wang_Ning`、`FLCCh_Wang_Hui` 等
   - **建议**：提供工号格式建议，但允许手动输入（更灵活）

3. **离职员工数据保留策略**：
   - 离职员工是否从列表中隐藏？
   - 历史数据（日程、评估）是否继续关联？
   - **建议**：软删除保留数据，列表默认只显示在职员工，可通过筛选器查看离职员工

4. **批量导入优先级**：是否第一阶段必须实现？
   - **建议**：第一阶段先实现基础 CRUD，批量导入作为第二阶段增强功能

## Alternatives Considered

### 方案A：继续使用 SQL 手动维护（当前方案）
- ❌ 缺点：门槛高、易出错、无法自助
- ✅ 优点：无需开发成本

### 方案B：使用 Supabase Dashboard 的 Table Editor
- ⚠️ 缺点：功能有限、无业务逻辑校验、界面不友好
- ✅ 优点：无需额外开发

### 方案C：开发完整的员工管理界面（推荐）
- ✅ 优点：用户体验好、数据质量高、可扩展性强
- ❌ 缺点：需要 3-5 天开发时间

**选择方案C**，因为员工信息是系统基础数据，值得投入开发资源提升维护效率。

## Success Criteria

完成后应达到以下标准：

1. ✅ Site PS 和 Admin 可通过界面查看所有员工列表
2. ✅ 可通过表单添加新员工（工号唯一性校验生效）
3. ✅ 可编辑现有员工信息（除工号外）
4. ✅ 可修改员工角色权限（BPS_ENGINEER ↔ SITE_PS）
5. ✅ 可设置员工为离职状态（软删除）
6. ✅ 普通 BPS 工程师无法访问员工管理页面
7. ✅ 所有操作正确更新数据库（验证 SQL 查询）
8. ✅ 界面响应式、加载速度快（< 2 秒）

## Estimated Effort

- **基础 CRUD 功能**：3 天
  - 列表页面：0.5 天
  - 表单组件：1 天
  - 权限集成：0.5 天
  - 测试验证：1 天

- **批量导入**（可选）：1.5 天
  - Excel 解析：0.5 天
  - 验证逻辑：0.5 天
  - 错误处理：0.5 天

- **操作日志**（可选）：1 天
  - 数据库表：0.25 天
  - 日志记录：0.5 天
  - 日志查看：0.25 天

**总计**：3-5.5 天（根据需求范围）

