# é‚®ç®±è®¤è¯ç³»ç»Ÿ - å®ç°æŒ‡å—

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

ä¸º BPS èƒ½åŠ›ç®¡ç†ç³»ç»Ÿæ·»åŠ åŸºäº Supabase Auth çš„é‚®ç®±è®¤è¯åŠŸèƒ½ï¼Œæ”¯æŒï¼š
- âœ… é‚®ç®± OTPï¼ˆä¸€æ¬¡æ€§éªŒè¯ç ï¼‰æ³¨å†Œå’Œç™»å½•
- âœ… é™åˆ¶åŸŸåï¼š`@bosch.com` å’Œ `@bshg.com`
- âœ… ç°æœ‰ç”¨æˆ·å¹³æ»‘è¿ç§»ï¼ˆé¦–æ¬¡ç™»å½•ç»‘å®šé‚®ç®±ï¼‰
- âœ… "è®°ä½æˆ‘"åŠŸèƒ½ï¼ˆ30 å¤©ä¼šè¯ï¼‰
- âœ… å¼€å‘ç¯å¢ƒä½¿ç”¨ Supabase å…è´¹é‚®ä»¶æœåŠ¡
- âœ… ç”Ÿäº§ç¯å¢ƒæ”¯æŒ Bosch SMTP é…ç½®

---

## ğŸ“ æ–‡æ¡£ç»“æ„

```
openspec/changes/add-email-authentication/
â”œâ”€â”€ README.md                           # ğŸ“– æœ¬æ–‡ä»¶ - æ€»è§ˆå’Œå¿«é€Ÿå¯¼èˆª
â”œâ”€â”€ proposal.md                         # ğŸ“„ å®Œæ•´æ–¹æ¡ˆè¯´æ˜
â”œâ”€â”€ tasks.md                            # âœ… è¯¦ç»†å®ç°ä»»åŠ¡æ¸…å•ï¼ˆ39 ä¸ªä»»åŠ¡ï¼‰
â”œâ”€â”€ QUICK_START.md                      # ğŸš€ 5 åˆ†é’Ÿå¿«é€Ÿå¼€å§‹æŒ‡å—
â”œâ”€â”€ SUPABASE_EMAIL_AUTH_GUIDE.md        # ğŸ”§ Supabase é…ç½®è¯¦ç»†æŒ‡å—
â”œâ”€â”€ USER_MIGRATION_GUIDE.md             # ğŸ”„ ç”¨æˆ·è¿ç§»æŒ‡å—
â””â”€â”€ migrations/
    â””â”€â”€ 002_add_email_authentication.sql # ğŸ’¾ æ•°æ®åº“è¿ç§»è„šæœ¬
```

---

## ğŸ¯ æ‚¨çš„éœ€æ±‚ç¡®è®¤

æ ¹æ®æ‚¨çš„å›å¤ï¼Œæˆ‘å·²ç¡®è®¤ä»¥ä¸‹éœ€æ±‚ï¼š

### 1. é‚®ç®±åŸŸåé™åˆ¶
- âœ… åªå…è®¸ `@bosch.com` æˆ– `@bshg.com` é‚®ç®±æ³¨å†Œ
- âœ… å‰ç«¯å’Œæ•°æ®åº“åŒé‡éªŒè¯

### 2. ç”¨æˆ·è¿ç§»æ–¹æ¡ˆ
- âœ… **æ–¹æ¡ˆ A**ï¼šé¦–æ¬¡ç™»å½•æ—¶è¦æ±‚ç»‘å®šé‚®ç®±å¹¶éªŒè¯
- âœ… ç°æœ‰ç”¨æˆ·æ•°æ®ä¿ç•™ï¼Œæƒé™ä¸å˜
- âœ… æä¾›ç®¡ç†å‘˜ååŠ©å·¥å…·

### 3. é‚®ä»¶æœåŠ¡é…ç½®
- âœ… **å¼€å‘/æµ‹è¯•ç¯å¢ƒ**ï¼šSupabase é»˜è®¤é‚®ä»¶æœåŠ¡ï¼ˆå…è´¹ï¼‰
- âœ… **ç”Ÿäº§ç¯å¢ƒ**ï¼šé…ç½® Bosch SMTPï¼ˆéœ€ IT éƒ¨é—¨ååŠ©ï¼‰

### 4. "è®°ä½æˆ‘"åŠŸèƒ½
- âœ… ç™»å½•æ—¶å¯é€‰æ‹©"è®°ä½æˆ‘"
- âœ… å‹¾é€‰å 30 å¤©å†…æ— éœ€é‡æ–°ç™»å½•
- âœ… æœªå‹¾é€‰åˆ™å…³é—­æµè§ˆå™¨åè‡ªåŠ¨ç™»å‡º

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¬¬ 1 æ­¥ï¼šäº†è§£ Supabase é‚®ä»¶è®¤è¯

**æ ¸å¿ƒé—®é¢˜**ï¼šSupabase å¦‚ä½•å‘é€éªŒè¯ç ï¼Ÿ

**ç­”æ¡ˆ**ï¼šSupabase è‡ªåŠ¨å¸®æ‚¨å‘é€é‚®ä»¶ï¼Œæ— éœ€ä»»ä½•é…ç½®ï¼

```javascript
// åªéœ€ä¸€è¡Œä»£ç 
await supabase.auth.signInWithOtp({ email: 'user@bosch.com' });
// Supabase ä¼šè‡ªåŠ¨å‘é€éªŒè¯ç åˆ°ç”¨æˆ·é‚®ç®±
```

**è¯¦ç»†è¯´æ˜**ï¼šè¯·é˜…è¯» [`QUICK_START.md`](./QUICK_START.md)ï¼ˆ5 åˆ†é’Ÿï¼‰

---

### ç¬¬ 2 æ­¥ï¼šé…ç½® Supabase Dashboard

1. ç™»å½• Supabase Dashboard
2. å¯ç”¨ Email OTP è®¤è¯
3. è‡ªå®šä¹‰é‚®ä»¶æ¨¡æ¿ï¼ˆä¸­æ–‡ï¼‰

**è¯¦ç»†æ­¥éª¤**ï¼šè¯·é˜…è¯» [`SUPABASE_EMAIL_AUTH_GUIDE.md`](./SUPABASE_EMAIL_AUTH_GUIDE.md)

---

### ç¬¬ 3 æ­¥ï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§»

åœ¨ Supabase SQL Editor æ‰§è¡Œï¼š

```sql
-- æ–‡ä»¶ä½ç½®ï¼šmigrations/002_add_email_authentication.sql
-- å¤åˆ¶å…¨éƒ¨å†…å®¹å¹¶æ‰§è¡Œ
```

**è¿ç§»å†…å®¹**ï¼š
- âœ… æ·»åŠ  `auth_user_id`, `email`, `phone` å­—æ®µ
- âœ… åˆ›å»ºè‡ªåŠ¨åŒæ­¥è§¦å‘å™¨
- âœ… å¯ç”¨ RLS ç­–ç•¥
- âœ… åˆ›å»ºè¾…åŠ©å‡½æ•°

---

### ç¬¬ 4 æ­¥ï¼šå®ç°å‰ç«¯åŠŸèƒ½

æŒ‰ç…§ [`tasks.md`](./tasks.md) çš„ä»»åŠ¡æ¸…å•é€æ­¥å®ç°ï¼š

**æ ¸å¿ƒä»»åŠ¡**ï¼š
1. åˆ›å»º `authService.ts`ï¼ˆè®¤è¯æœåŠ¡å±‚ï¼‰
2. é‡æ„ `AuthContext`ï¼ˆé›†æˆ Supabase Authï¼‰
3. åˆ›å»º `EmailInput` å’Œ `OTPInput` ç»„ä»¶
4. é‡æ„ `LoginScreen`ï¼ˆæ”¯æŒé‚®ç®± OTPï¼‰
5. åˆ›å»º `SignupScreen`ï¼ˆæ³¨å†Œé¡µé¢ï¼‰
6. åˆ›å»º `BindEmailScreen`ï¼ˆé‚®ç®±ç»‘å®šé¡µé¢ï¼‰

**é¢„è®¡æ—¶é—´**ï¼š13.5 å°æ—¶

---

### ç¬¬ 5 æ­¥ï¼šæµ‹è¯•å’Œä¸Šçº¿

1. æµ‹è¯•é‚®ä»¶å‘é€ï¼ˆä½¿ç”¨çœŸå®é‚®ç®±ï¼‰
2. æµ‹è¯•æ³¨å†Œ/ç™»å½•æµç¨‹
3. æµ‹è¯•ç”¨æˆ·è¿ç§»æµç¨‹
4. æµ‹è¯•"è®°ä½æˆ‘"åŠŸèƒ½
5. å®‰å…¨æµ‹è¯•ï¼ˆåŸŸåé™åˆ¶ã€RLS ç­–ç•¥ï¼‰

**è¯¦ç»†æµ‹è¯•æ¸…å•**ï¼šè§ [`tasks.md`](./tasks.md) é˜¶æ®µ 8

---

## ğŸ“š æ–‡æ¡£å¯¼èˆª

### ğŸ†• æ–°æ‰‹å…¥é—¨

1. **å…ˆçœ‹è¿™ä¸ª**ï¼š[`QUICK_START.md`](./QUICK_START.md)
   - 5 åˆ†é’Ÿäº†è§£ Supabase é‚®ä»¶è®¤è¯
   - 3 æ­¥å¯ç”¨é‚®ç®± OTP
   - æµ‹è¯•é‚®ä»¶å‘é€

2. **ç„¶åçœ‹è¿™ä¸ª**ï¼š[`proposal.md`](./proposal.md)
   - ä¸ºä»€ä¹ˆéœ€è¦é‚®ç®±è®¤è¯ï¼Ÿ
   - å®ç°ä»€ä¹ˆåŠŸèƒ½ï¼Ÿ
   - æŠ€æœ¯æ–¹æ¡ˆè¯¦è§£

### ğŸ”§ æŠ€æœ¯äººå‘˜

1. **é…ç½®æŒ‡å—**ï¼š[`SUPABASE_EMAIL_AUTH_GUIDE.md`](./SUPABASE_EMAIL_AUTH_GUIDE.md)
   - Supabase Dashboard é…ç½®æ­¥éª¤
   - é‚®ä»¶æ¨¡æ¿è‡ªå®šä¹‰
   - RLS ç­–ç•¥é…ç½®
   - ä»£ç ç¤ºä¾‹

2. **å®ç°æ¸…å•**ï¼š[`tasks.md`](./tasks.md)
   - 39 ä¸ªè¯¦ç»†ä»»åŠ¡
   - åˆ† 9 ä¸ªé˜¶æ®µ
   - é¢„è®¡ 13.5 å°æ—¶

3. **æ•°æ®åº“è¿ç§»**ï¼š[`migrations/002_add_email_authentication.sql`](./migrations/002_add_email_authentication.sql)
   - è¡¨ç»“æ„å˜æ›´
   - è§¦å‘å™¨å’Œå‡½æ•°
   - RLS ç­–ç•¥

### ğŸ‘¥ ç®¡ç†å‘˜

1. **ç”¨æˆ·è¿ç§»**ï¼š[`USER_MIGRATION_GUIDE.md`](./USER_MIGRATION_GUIDE.md)
   - è¿ç§»æµç¨‹è¯´æ˜
   - ç®¡ç†å‘˜ååŠ©æ­¥éª¤
   - å¸¸è§é—®é¢˜è§£ç­”
   - è¿ç§»è¿›åº¦è¿½è¸ª

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### é‚®ç®± OTP è®¤è¯æµç¨‹

```
æ³¨å†Œæµç¨‹ï¼š
ç”¨æˆ·è¾“å…¥é‚®ç®± â†’ Supabase å‘é€éªŒè¯ç  â†’ ç”¨æˆ·è¾“å…¥éªŒè¯ç  â†’ æ³¨å†ŒæˆåŠŸ

ç™»å½•æµç¨‹ï¼š
ç”¨æˆ·è¾“å…¥é‚®ç®± â†’ Supabase å‘é€éªŒè¯ç  â†’ ç”¨æˆ·è¾“å…¥éªŒè¯ç  â†’ ç™»å½•æˆåŠŸ

è¿ç§»æµç¨‹ï¼ˆç°æœ‰ç”¨æˆ·ï¼‰ï¼š
æ—§ç³»ç»Ÿæ£€æµ‹ â†’ æ˜¾ç¤ºç»‘å®šé¡µé¢ â†’ è¾“å…¥é‚®ç®± â†’ éªŒè¯ç éªŒè¯ â†’ ç»‘å®šæˆåŠŸ
```

### æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯åº”ç”¨   â”‚ â”€â”€â”€> â”‚  Supabase    â”‚ â”€â”€â”€> â”‚  ç”¨æˆ·é‚®ç®±   â”‚
â”‚             â”‚      â”‚  Auth        â”‚      â”‚             â”‚
â”‚ authService â”‚      â”‚              â”‚      â”‚ æ”¶åˆ°éªŒè¯ç   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                     â”‚
       â”‚                     â”‚
       â†“                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthContext â”‚      â”‚ auth.users   â”‚
â”‚             â”‚ <â”€â”€â”€ â”‚              â”‚
â”‚ currentUser â”‚      â”‚ (Supabase)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                     â”‚
       â”‚                     â”‚ (è§¦å‘å™¨è‡ªåŠ¨åŒæ­¥)
       â†“                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸»åº”ç”¨     â”‚      â”‚ employees    â”‚
â”‚             â”‚ <â”€â”€â”€ â”‚              â”‚
â”‚  UI ç»„ä»¶    â”‚      â”‚ (ä¸šåŠ¡æ•°æ®)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš¡ å…³é”®æŠ€æœ¯ç‚¹

### 1. Supabase Auth Session ç®¡ç†

```typescript
// æŒä¹…åŒ–ä¼šè¯ï¼ˆæ”¯æŒ"è®°ä½æˆ‘"ï¼‰
const supabase = createClient(url, key, {
  auth: {
    persistSession: true,        // æŒä¹…åŒ–ä¼šè¯
    autoRefreshToken: true,      // è‡ªåŠ¨åˆ·æ–° Token
    storage: window.localStorage // ä½¿ç”¨ localStorage
  }
});
```

### 2. é‚®ç®±åŸŸåéªŒè¯

```typescript
// å‰ç«¯éªŒè¯
function validateEmail(email: string): boolean {
  return email.endsWith('@bosch.com') || email.endsWith('@bshg.com');
}

// æ•°æ®åº“çº¦æŸ
ALTER TABLE employees 
ADD CONSTRAINT email_domain_check 
CHECK (email LIKE '%@bosch.com' OR email LIKE '%@bshg.com');
```

### 3. è‡ªåŠ¨åŒæ­¥è§¦å‘å™¨

```sql
-- auth.users åˆ›å»ºæ–°ç”¨æˆ·æ—¶ï¼Œè‡ªåŠ¨åœ¨ employees è¡¨åˆ›å»ºè®°å½•
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION handle_new_auth_user();
```

### 4. RLS ç­–ç•¥

```sql
-- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ•°æ®
CREATE POLICY "Users can view own data"
ON employees
FOR SELECT
USING (auth.uid() = auth_user_id);

-- ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ•°æ®
CREATE POLICY "Admins can view all data"
ON employees
FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM employees
    WHERE auth_user_id = auth.uid()
    AND role = 'ADMIN'
  )
);
```

---

## ğŸ“Š å®ç°è¿›åº¦

å½“å‰çŠ¶æ€ï¼š**å‡†å¤‡é˜¶æ®µ** âœ…

- [x] éœ€æ±‚ç¡®è®¤
- [x] æ–¹æ¡ˆè®¾è®¡
- [x] æ–‡æ¡£ç¼–å†™
- [x] æ•°æ®åº“è¿ç§»è„šæœ¬
- [ ] Supabase é…ç½®
- [ ] å‰ç«¯å®ç°
- [ ] æµ‹è¯•
- [ ] ä¸Šçº¿

---

## ğŸ”— ç›¸å…³èµ„æº

### Supabase å®˜æ–¹æ–‡æ¡£
- [Auth æ¦‚è§ˆ](https://supabase.com/docs/guides/auth)
- [Email OTP](https://supabase.com/docs/guides/auth/auth-email)
- [è‡ªå®šä¹‰ SMTP](https://supabase.com/docs/guides/auth/auth-smtp)
- [RLS ç­–ç•¥](https://supabase.com/docs/guides/auth/row-level-security)

### é¡¹ç›®æ–‡æ¡£
- `openspec/project.md` - é¡¹ç›®æ€»è§ˆ
- `openspec/AGENTS.md` - OpenSpec å·¥ä½œæµç¨‹

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q: Supabase å¦‚ä½•å‘é€é‚®ä»¶ï¼Ÿ
**A**: Supabase å†…ç½®é‚®ä»¶æœåŠ¡ï¼Œè°ƒç”¨ `signInWithOtp()` å³å¯è‡ªåŠ¨å‘é€ã€‚è¯¦è§ [`QUICK_START.md`](./QUICK_START.md)ã€‚

### Q: å…è´¹é¢åº¦å¤Ÿç”¨å—ï¼Ÿ
**A**: å¼€å‘ç¯å¢ƒè¶³å¤Ÿï¼ˆæ¯å°æ—¶ 30 å°ï¼‰ã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®®é…ç½® Bosch SMTPã€‚

### Q: ç°æœ‰ç”¨æˆ·å¦‚ä½•è¿ç§»ï¼Ÿ
**A**: é¦–æ¬¡ç™»å½•æ—¶è‡ªåŠ¨æç¤ºç»‘å®šé‚®ç®±ã€‚è¯¦è§ [`USER_MIGRATION_GUIDE.md`](./USER_MIGRATION_GUIDE.md)ã€‚

### Q: å¦‚ä½•é™åˆ¶åŸŸåï¼Ÿ
**A**: å‰ç«¯ + æ•°æ®åº“åŒé‡éªŒè¯ï¼Œåªå…è®¸ `@bosch.com` å’Œ `@bshg.com`ã€‚

### Q: "è®°ä½æˆ‘"å¦‚ä½•å®ç°ï¼Ÿ
**A**: ä½¿ç”¨ Supabase çš„ Refresh Tokenï¼ˆ30 å¤©æœ‰æ•ˆæœŸï¼‰+ `persistSession: true`ã€‚

---

## ğŸš€ å¼€å§‹å®ç°

å‡†å¤‡å¥½äº†å—ï¼ŸæŒ‰ç…§ä»¥ä¸‹é¡ºåºå¼€å§‹ï¼š

1. âœ… é˜…è¯» [`QUICK_START.md`](./QUICK_START.md)ï¼ˆ5 åˆ†é’Ÿï¼‰
2. âœ… é…ç½® Supabase Dashboardï¼ˆ30 åˆ†é’Ÿï¼‰
3. âœ… æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼ˆ10 åˆ†é’Ÿï¼‰
4. âœ… æŒ‰ç…§ [`tasks.md`](./tasks.md) å®ç°å‰ç«¯ï¼ˆ13 å°æ—¶ï¼‰
5. âœ… æµ‹è¯•å’Œä¸Šçº¿ï¼ˆ2 å°æ—¶ï¼‰

**æ€»é¢„è®¡æ—¶é—´**ï¼šçº¦ 2 ä¸ªå·¥ä½œæ—¥

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- æŠ€æœ¯é—®é¢˜ï¼šæŸ¥çœ‹ [`SUPABASE_EMAIL_AUTH_GUIDE.md`](./SUPABASE_EMAIL_AUTH_GUIDE.md)
- ç”¨æˆ·è¿ç§»ï¼šæŸ¥çœ‹ [`USER_MIGRATION_GUIDE.md`](./USER_MIGRATION_GUIDE.md)
- ä»»åŠ¡æ¸…å•ï¼šæŸ¥çœ‹ [`tasks.md`](./tasks.md)

---

**ç¥å®ç°é¡ºåˆ©ï¼** ğŸ‰

